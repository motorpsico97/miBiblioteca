<link rel="stylesheet" href="/css/home.css">

<h1 class="page-title">CatÃ¡logo de Libros</h1>

<div class="main-layout">
    <aside class="filters-sidebar">
        <div class="filters-header">
            <h2>ğŸ” Filtros</h2>
            {{#if categoria}}{{#if genero}}{{#if autor}}
            <a href="/" class="clear-all-filters">Limpiar todos</a>
            {{else}}
            <a href="/" class="clear-all-filters">Limpiar todos</a>
            {{/if}}{{else}}{{#if autor}}
            <a href="/" class="clear-all-filters">Limpiar todos</a>
            {{else}}
            <a href="/" class="clear-all-filters">Limpiar</a>
            {{/if}}{{/if}}{{else}}{{#if genero}}{{#if autor}}
            <a href="/" class="clear-all-filters">Limpiar todos</a>
            {{else}}
            <a href="/" class="clear-all-filters">Limpiar</a>
            {{/if}}{{else}}{{#if autor}}
            <a href="/" class="clear-all-filters">Limpiar</a>
            {{/if}}{{/if}}{{/if}}
        </div>

        <div class="filter-section">
            <h3>ğŸ“š CategorÃ­as</h3>
            <ul class="filter-list">
                {{#each allCategorias}}
                <li class="filter-item">
                    <button 
                        class="filter-button {{#if (eq ../categoria this)}}active{{/if}}" 
                        onclick="toggleFilter('categoria', '{{this}}')"
                    >
                        {{this}}
                    </button>
                </li>
                {{/each}}
            </ul>
        </div>

        <div class="filter-section">
            <h3>ğŸ·ï¸ GÃ©neros</h3>
            <ul class="filter-list">
                {{#each allGeneros}}
                <li class="filter-item">
                    <button 
                        class="filter-button {{#if (eq ../genero this)}}active{{/if}}" 
                        onclick="toggleFilter('genero', '{{this}}')"
                    >
                        {{this}}
                    </button>
                </li>
                {{/each}}
            </ul>
        </div>
    </aside>

    <div class="main-content">
        <div class="search-container">
    <form action="/" method="GET" class="search-form">
        <input 
            type="text" 
            name="search" 
            class="search-input" 
            placeholder="Buscar por tÃ­tulo, autor, editorial, categorÃ­a, gÃ©nero..."
            value="{{search}}"
        >
        <button type="submit" class="search-button">
            ğŸ” Buscar
        </button>
        {{#if search}}
        <a href="/" class="clear-search">âœ• Limpiar</a>
        {{/if}}
    </form>
    
    {{#if categoria}}{{#if genero}}{{#if autor}}
    <div class="active-filters">
        <span class="filter-label">Filtros activos:</span>
        <span class="active-filter">ğŸ“š {{categoria}} <button class="remove-filter" onclick="removeFilter('categoria')">âœ•</button></span>
        <span class="active-filter">ğŸ·ï¸ {{genero}} <button class="remove-filter" onclick="removeFilter('genero')">âœ•</button></span>
        <span class="active-filter">âœï¸ {{autor}} <button class="remove-filter" onclick="removeFilter('autor')">âœ•</button></span>
    </div>
    {{else}}
    <div class="active-filters">
        <span class="filter-label">Filtros activos:</span>
        <span class="active-filter">ğŸ“š {{categoria}} <button class="remove-filter" onclick="removeFilter('categoria')">âœ•</button></span>
        <span class="active-filter">ğŸ·ï¸ {{genero}} <button class="remove-filter" onclick="removeFilter('genero')">âœ•</button></span>
    </div>
    {{/if}}{{else}}{{#if autor}}
    <div class="active-filters">
        <span class="filter-label">Filtros activos:</span>
        <span class="active-filter">ğŸ“š {{categoria}} <button class="remove-filter" onclick="removeFilter('categoria')">âœ•</button></span>
        <span class="active-filter">âœï¸ {{autor}} <button class="remove-filter" onclick="removeFilter('autor')">âœ•</button></span>
    </div>
    {{else}}
    <div class="active-filters">
        <span class="filter-label">Filtros activos:</span>
        <span class="active-filter">ğŸ“š {{categoria}} <button class="remove-filter" onclick="removeFilter('categoria')">âœ•</button></span>
    </div>
    {{/if}}{{/if}}{{else}}{{#if genero}}{{#if autor}}
    <div class="active-filters">
        <span class="filter-label">Filtros activos:</span>
        <span class="active-filter">ğŸ·ï¸ {{genero}} <button class="remove-filter" onclick="removeFilter('genero')">âœ•</button></span>
        <span class="active-filter">âœï¸ {{autor}} <button class="remove-filter" onclick="removeFilter('autor')">âœ•</button></span>
    </div>
    {{else}}
    <div class="active-filters">
        <span class="filter-label">Filtros activos:</span>
        <span class="active-filter">ğŸ·ï¸ {{genero}} <button class="remove-filter" onclick="removeFilter('genero')">âœ•</button></span>
    </div>
    {{/if}}{{else}}{{#if autor}}
    <div class="active-filters">
        <span class="filter-label">Filtros activos:</span>
        <span class="active-filter">âœï¸ {{autor}} <button class="remove-filter" onclick="removeFilter('autor')">âœ•</button></span>
    </div>
    {{/if}}{{/if}}{{/if}}
    
    {{#if search}}
    <p class="search-results-info">
        {{#if libros.length}}
            Mostrando {{libros.length}} resultado(s) para "{{search}}"
        {{else}}
            No se encontraron resultados para "{{search}}"
        {{/if}}
    </p>
    {{/if}}
</div>

<div class="books-container">
    {{#if libros.length}}
        <ul class="books-grid">
            {{#each libros}}
                <li class="book-card">
                    <img
                        src="{{this.portada}}"
                        alt="{{this.titulo}}"
                        class="book-cover"
                    />
                    <a href="/libro/{{this._id}}" class="book-link">
                        <h2 class="book-title">{{this.titulo}}</h2>
                    </a>
                    <p class="book-author" data-autor="{{this.autor}}" onclick="toggleFilter('autor', '{{this.autor}}')">{{this.autor}}</p>
                    {{#if this.aÃ±o}}
                    <p class="book-year">ğŸ“… {{this.aÃ±o}}</p>
                    {{/if}}
                    {{#if this.categoria}}
                    <div class="book-categories">
                        {{#each this.categoria}}
                            <span class="category-tag" data-categoria="{{this}}" onclick="toggleFilter('categoria', '{{this}}')">{{this}}</span>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{#if this.genero}}
                    <div class="book-genres">
                        {{#each this.genero}}
                            <span class="genre-tag" data-genero="{{this}}" onclick="toggleFilter('genero', '{{this}}')">{{this}}</span>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{#if this.estado}}
                    <div class="book-status">
                        <span class="status-badge status-{{this.estado}}">{{this.estado}}</span>
                    </div>
                    {{/if}}
                </li>
            {{/each}}
        </ul>

        {{#if links}}
        <div class="pagination-container">
            {{#each links}}
                <a href="{{this.link}}" class="pagination-link {{#if this.active}}active{{/if}}">{{this.text}}</a>
            {{/each}}
        </div>
        {{/if}}
    {{else}}
        <div class="empty-state">
            <h2>ğŸ“– No hay libros disponibles</h2>
            <p>El catÃ¡logo estÃ¡ vacÃ­o en este momento.</p>
        </div>
    {{/if}}
</div>
    </div>
</div>

<script>
    // Obtener parÃ¡metros actuales de la URL
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            search: params.get('search') || '',
            categoria: params.get('categoria') || '',
            genero: params.get('genero') || '',
            autor: params.get('autor') || ''
        };
    }

    // FunciÃ³n para alternar filtros
    function toggleFilter(type, value) {
        const params = getUrlParams();
        
        // Si el filtro ya estÃ¡ activo, quitarlo; si no, agregarlo
        if (params[type] === value) {
            delete params[type];
        } else {
            params[type] = value;
        }
        
        // Construir nueva URL
        const urlParams = new URLSearchParams();
        if (params.search) urlParams.set('search', params.search);
        if (params.categoria) urlParams.set('categoria', params.categoria);
        if (params.genero) urlParams.set('genero', params.genero);
        if (params.autor) urlParams.set('autor', params.autor);
        urlParams.set('limit', '20');
        urlParams.set('page', '1');
        
        // Redirigir
        window.location.href = '/?' + urlParams.toString();
    }

    // FunciÃ³n para remover un filtro especÃ­fico
    function removeFilter(type) {
        const params = getUrlParams();
        delete params[type];
        
        const urlParams = new URLSearchParams();
        if (params.search) urlParams.set('search', params.search);
        if (params.categoria) urlParams.set('categoria', params.categoria);
        if (params.genero) urlParams.set('genero', params.genero);
        if (params.autor) urlParams.set('autor', params.autor);
        urlParams.set('limit', '20');
        urlParams.set('page', '1');
        
        window.location.href = '/?' + urlParams.toString();
    }

    // Marcar visualmente las etiquetas activas
    document.addEventListener('DOMContentLoaded', function() {
        const params = getUrlParams();
        
        // Marcar categorÃ­a activa
        if (params.categoria) {
            document.querySelectorAll('.category-tag').forEach(tag => {
                if (tag.dataset.categoria === params.categoria) {
                    tag.classList.add('active');
                }
            });
        }
        
        // Marcar gÃ©nero activo
        if (params.genero) {
            document.querySelectorAll('.genre-tag').forEach(tag => {
                if (tag.dataset.genero === params.genero) {
                    tag.classList.add('active');
                }
            });
        }
        
        // Marcar autor activo
        if (params.autor) {
            document.querySelectorAll('.book-author').forEach(author => {
                if (author.dataset.autor === params.autor) {
                    author.classList.add('active');
                }
            });
        }
    });
</script>