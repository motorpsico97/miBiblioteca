<link rel="stylesheet" href="/css/home.css">

<h1 class="page-title">Cat√°logo de Libros</h1>

<div class="main-layout">
    <aside class="filters-sidebar">
        <div class="filters-header">
            <h2>üîç Filtros</h2>
            {{#if categorias.length}}{{#if generos.length}}{{#if autor}}
            <a href="/" class="clear-all-filters">Limpiar todos</a>
            {{else}}
            <a href="/" class="clear-all-filters">Limpiar todos</a>
            {{/if}}{{else}}{{#if autor}}
            <a href="/" class="clear-all-filters">Limpiar todos</a>
            {{else}}
            <a href="/" class="clear-all-filters">Limpiar</a>
            {{/if}}{{/if}}{{else}}{{#if generos.length}}{{#if autor}}
            <a href="/" class="clear-all-filters">Limpiar todos</a>
            {{else}}
            <a href="/" class="clear-all-filters">Limpiar</a>
            {{/if}}{{else}}{{#if autor}}
            <a href="/" class="clear-all-filters">Limpiar</a>
            {{/if}}{{/if}}{{/if}}
        </div>

        <div class="filter-section">
            <h3>üìö Categor√≠as</h3>
            <ul class="filter-list">
                {{#each allCategorias}}
                <li class="filter-item">
                    <button 
                        class="filter-button" 
                        data-filter-type="categoria"
                        data-filter-value="{{this}}"
                        onclick="toggleFilter('categoria', '{{this}}')"
                    >
                        {{this}}
                    </button>
                </li>
                {{/each}}
            </ul>
        </div>

        <div class="filter-section">
            <h3>üè∑Ô∏è G√©neros</h3>
            <ul class="filter-list">
                {{#each allGeneros}}
                <li class="filter-item">
                    <button 
                        class="filter-button" 
                        data-filter-type="genero"
                        data-filter-value="{{this}}"
                        onclick="toggleFilter('genero', '{{this}}')"
                    >
                        {{this}}
                    </button>
                </li>
                {{/each}}
            </ul>
        </div>
    </aside>

    <div class="main-content">
        <div class="filters-info">
    {{#if search}}
    <p class="search-results-info">
        {{#if libros.length}}
            Mostrando {{libros.length}} resultado(s) para "{{search}}"
        {{else}}
            No se encontraron resultados para "{{search}}"
        {{/if}}
        <a href="/" class="clear-search-inline">‚úï Limpiar b√∫squeda</a>
    </p>
    {{/if}}
    
    {{#if categorias.length}}
    <div class="active-filters">
        <span class="filter-label">Categor√≠as activas:</span>
        {{#each categorias}}
        <span class="active-filter">üìö {{this}} <button class="remove-filter" onclick="removeFilter('categoria', '{{this}}')">‚úï</button></span>
        {{/each}}
    </div>
    {{/if}}
    
    {{#if generos.length}}
    <div class="active-filters">
        <span class="filter-label">G√©neros activos:</span>
        {{#each generos}}
        <span class="active-filter">üè∑Ô∏è {{this}} <button class="remove-filter" onclick="removeFilter('genero', '{{this}}')">‚úï</button></span>
        {{/each}}
    </div>
    {{/if}}
    
    {{#if autor}}
    <div class="active-filters">
        <span class="filter-label">Autor activo:</span>
        <span class="active-filter">‚úçÔ∏è {{autor}} <button class="remove-filter" onclick="removeFilter('autor')">‚úï</button></span>
    </div>
    {{/if}}
</div>

<div class="books-container">
    {{#if libros.length}}
        <div class="sort-container">
            <label for="sort-selector">Ordenar por:</label>
            <select id="sort-selector" class="sort-selector" onchange="changeSort(this.value)">
                <option value="" {{#unless sort}}selected{{/unless}}>Por defecto (M√°s recientes)</option>
                <option value="az" {{#if (eq sort "az")}}selected{{/if}}>A - Z</option>
                <option value="za" {{#if (eq sort "za")}}selected{{/if}}>Z - A</option>
            </select>
        </div>
        
        <ul class="books-grid">
            {{#each libros}}
                <li class="book-card">
                    <a href="/libro/{{this._id}}" class="book-link">
                        <h2 class="book-title">{{this.titulo}}</h2>
                    
                    <img
                        src="{{this.portada}}"
                        alt="{{this.titulo}}"
                        class="book-cover"
                    />
                    </a>
                    <p class="book-author" data-autor="{{this.autor}}" onclick="toggleFilter('autor', '{{this.autor}}')">{{this.autor}}</p>
                    {{#if this.categoria}}
                    <div class="book-categories">
                        {{#each this.categoria}}
                            <span class="category-tag" data-categoria="{{this}}" onclick="toggleFilter('categoria', '{{this}}')">{{this}}</span>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{#if this.genero}}
                    <div class="book-genres">
                        {{#each this.genero}}
                            <span class="genre-tag" data-genero="{{this}}" onclick="toggleFilter('genero', '{{this}}')">{{this}}</span>
                        {{/each}}
                    </div>
                    {{/if}}
                </li>
            {{/each}}
        </ul>

        {{#if pagination}}
        <div class="limit-selector-container">
            <label for="limit-selector">Libros por p√°gina:</label>
            <select id="limit-selector" class="limit-selector" onchange="changeLimit(this.value)">
                <option value="20" {{#if (eq limit "20")}}selected{{/if}}>20</option>
                <option value="30" {{#if (eq limit "30")}}selected{{/if}}>30</option>
                <option value="40" {{#if (eq limit "40")}}selected{{/if}}>40</option>
            </select>
        </div>
        
        <div class="pagination-container">
            {{#if pagination.hasPrevPage}}
                <a href="/?page=1{{#if search}}&search={{search}}{{/if}}{{#each categorias}}&categoria={{this}}{{/each}}{{#each generos}}&genero={{this}}{{/each}}{{#if autor}}&autor={{autor}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}&limit={{limit}}" class="pagination-btn pagination-first">
                    ‚èÆ Inicio
                </a>
                <a href="/?page={{pagination.prevPage}}{{#if search}}&search={{search}}{{/if}}{{#each categorias}}&categoria={{this}}{{/each}}{{#each generos}}&genero={{this}}{{/each}}{{#if autor}}&autor={{autor}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}&limit={{limit}}" class="pagination-btn pagination-prev">
                    ‚Üê Anterior
                </a>
            {{else}}
                <span class="pagination-btn pagination-first disabled">‚èÆ Inicio</span>
                <span class="pagination-btn pagination-prev disabled">‚Üê Anterior</span>
            {{/if}}
            
            {{#if links}}
            <div class="pagination-pages">
                {{#each links}}
                    <a href="{{this.link}}" class="pagination-link {{#if this.active}}active{{/if}}">{{this.text}}</a>
                {{/each}}
            </div>
            {{/if}}
            
            {{#if pagination.hasNextPage}}
                <a href="/?page={{pagination.nextPage}}{{#if search}}&search={{search}}{{/if}}{{#each categorias}}&categoria={{this}}{{/each}}{{#each generos}}&genero={{this}}{{/each}}{{#if autor}}&autor={{autor}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}&limit={{limit}}" class="pagination-btn pagination-next">
                    Siguiente ‚Üí
                </a>
            {{else}}
                <span class="pagination-btn pagination-next disabled">Siguiente ‚Üí</span>
            {{/if}}
        </div>
        <p class="pagination-info">P√°gina {{pagination.page}} de {{pagination.totalPages}} | Total: {{pagination.totalDocs}} libros</p>
        {{/if}}
    {{else}}
        <div class="empty-state">
            <h2>üìñ No hay libros disponibles</h2>
            <p>El cat√°logo est√° vac√≠o en este momento.</p>
        </div>
    {{/if}}
</div>
    </div>
</div>

<script>
    // Obtener par√°metros actuales de la URL
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            search: params.get('search') || '',
            categorias: params.getAll('categoria') || [],
            generos: params.getAll('genero') || [],
            autor: params.get('autor') || '',
            limit: params.get('limit') || '20',
            sort: params.get('sort') || ''
        };
    }

    // Funci√≥n para cambiar el ordenamiento
    function changeSort(newSort) {
        const params = getUrlParams();
        const urlParams = new URLSearchParams();
        
        if (params.search) urlParams.set('search', params.search);
        params.categorias.forEach(c => urlParams.append('categoria', c));
        params.generos.forEach(g => urlParams.append('genero', g));
        if (params.autor) urlParams.set('autor', params.autor);
        if (params.limit) urlParams.set('limit', params.limit);
        if (newSort) urlParams.set('sort', newSort);
        urlParams.set('page', '1');
        
        window.location.href = '/?' + urlParams.toString();
    }

    // Funci√≥n para cambiar el l√≠mite de libros por p√°gina
    function changeLimit(newLimit) {
        const params = getUrlParams();
        const urlParams = new URLSearchParams();
        
        if (params.search) urlParams.set('search', params.search);
        params.categorias.forEach(c => urlParams.append('categoria', c));
        params.generos.forEach(g => urlParams.append('genero', g));
        if (params.autor) urlParams.set('autor', params.autor);
        if (params.sort) urlParams.set('sort', params.sort);
        urlParams.set('limit', newLimit);
        urlParams.set('page', '1');
        
        window.location.href = '/?' + urlParams.toString();
    }

    // Funci√≥n para alternar filtros (m√∫ltiples para categor√≠a/g√©nero, √∫nico para autor)
    function toggleFilter(type, value) {
        const params = getUrlParams();
        const urlParams = new URLSearchParams();
        
        if (type === 'autor') {
            // Autor: selecci√≥n √∫nica
            if (params.autor === value) {
                params.autor = ''; // Quitar si ya est√° seleccionado
            } else {
                params.autor = value; // Reemplazar con el nuevo
            }
        } else {
            // Categor√≠a y G√©nero: m√∫ltiples selecciones
            let array = [];
            if (type === 'categoria') array = params.categorias;
            else if (type === 'genero') array = params.generos;
            
            // Alternar el valor en el array
            const index = array.indexOf(value);
            if (index > -1) {
                array.splice(index, 1); // Remover si ya existe
            } else {
                array.push(value); // Agregar si no existe
            }
            
            // Actualizar params
            if (type === 'categoria') params.categorias = array;
            else if (type === 'genero') params.generos = array;
        }
        
        // Construir nueva URL
        if (params.search) urlParams.set('search', params.search);
        params.categorias.forEach(c => urlParams.append('categoria', c));
        params.generos.forEach(g => urlParams.append('genero', g));
        if (params.autor) urlParams.set('autor', params.autor);
        if (params.limit) urlParams.set('limit', params.limit);
        if (params.sort) urlParams.set('sort', params.sort);
        urlParams.set('page', '1');
        
        // Redirigir
        window.location.href = '/?' + urlParams.toString();
    }

    // Funci√≥n para remover un filtro espec√≠fico
    function removeFilter(type, value) {
        const params = getUrlParams();
        const urlParams = new URLSearchParams();
        
        if (type === 'autor') {
            // Para autor, simplemente limpiar
            params.autor = '';
        } else {
            // Para categor√≠a y g√©nero, remover del array
            if (type === 'categoria') {
                const index = params.categorias.indexOf(value);
                if (index > -1) params.categorias.splice(index, 1);
            } else if (type === 'genero') {
                const index = params.generos.indexOf(value);
                if (index > -1) params.generos.splice(index, 1);
            }
        }
        
        // Construir nueva URL
        if (params.search) urlParams.set('search', params.search);
        params.categorias.forEach(c => urlParams.append('categoria', c));
        params.generos.forEach(g => urlParams.append('genero', g));
        if (params.autor) urlParams.set('autor', params.autor);
        if (params.limit) urlParams.set('limit', params.limit);
        if (params.sort) urlParams.set('sort', params.sort);
        urlParams.set('page', '1');
        
        window.location.href = '/?' + urlParams.toString();
    }

    // Marcar visualmente las etiquetas activas
    document.addEventListener('DOMContentLoaded', function() {
        const params = getUrlParams();
        
        // Marcar categor√≠as activas (m√∫ltiples)
        if (params.categorias.length > 0) {
            document.querySelectorAll('.filter-button[data-filter-type="categoria"]').forEach(button => {
                if (params.categorias.includes(button.dataset.filterValue)) {
                    button.classList.add('active');
                }
            });
        }
        
        // Marcar g√©neros activos (m√∫ltiples)
        if (params.generos.length > 0) {
            document.querySelectorAll('.filter-button[data-filter-type="genero"]').forEach(button => {
                if (params.generos.includes(button.dataset.filterValue)) {
                    button.classList.add('active');
                }
            });
        }
        
        // Marcar autor activo (√∫nico)
        if (params.autor) {
            document.querySelectorAll('.filter-button[data-filter-type="autor"]').forEach(button => {
                if (button.dataset.filterValue === params.autor) {
                    button.classList.add('active');
                }
            });
        }
    });
</script>