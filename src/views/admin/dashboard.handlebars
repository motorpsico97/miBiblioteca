<link rel="stylesheet" href="/css/dashboard.css">

<div class="content">
    <div class="dashboard-header">
        <h2>Gesti√≥n de Libros</h2>
        <a href="/admin/books/create" class="btn-add">
            + Agregar Nuevo Libro
        </a>
    </div>

    {{#if success}}
    <div class="alert alert-success">{{success}}</div>
    {{/if}}

    <div class="search-bar">
        <form action="/admin/dashboard" method="GET" class="search-form">
            <input 
                type="text" 
                name="search" 
                class="search-input" 
                placeholder="Buscar por t√≠tulo, autor, editorial, categor√≠a, g√©nero, estado..."
                value="{{search}}"
            >
            <button type="submit" class="search-button">üîç Buscar</button>
            {{#if search}}
            <a href="/admin/dashboard" class="clear-search">‚úï Limpiar</a>
            {{/if}}
        </form>
        {{#if search}}
        <p class="search-results-info">
            {{#if libros.length}}
                Mostrando {{libros.length}} resultado(s) para "{{search}}"
            {{else}}
                No se encontraron resultados para "{{search}}"
            {{/if}}
        </p>
        {{/if}}
    </div>

    {{#if pagination}}
    <p class="pagination-info">
        Total: {{pagination.totalDocs}} libros | P√°gina {{pagination.page}} de {{pagination.totalPages}}
    </p>
    {{/if}}

    {{#if libros.length}}
    <div class="sort-container">
        <label for="sort-selector-admin">Ordenar por:</label>
        <select id="sort-selector-admin" class="sort-selector" onchange="changeSortAdmin(this.value)">
            <option value="" {{#unless sort}}selected{{/unless}}>Por defecto (M√°s recientes)</option>
            <option value="az" {{#if (eq sort "az")}}selected{{/if}}>A - Z</option>
            <option value="za" {{#if (eq sort "za")}}selected{{/if}}>Z - A</option>
        </select>
    </div>
    
    <table class="books-table">
        <thead>
            <tr>
                <th>T√≠tulo</th>
                <th>Autor</th>
                <th class="center">A√±o</th>
                <th>Editorial</th>
                <th class="center">Estado</th>
                <th class="center">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {{#each libros}}
            <tr>
                <td>{{titulo}}</td>
                <td>{{autor}}</td>
                <td class="center">{{year}}</td>
                <td>{{editorial}}</td>
                <td class="center">
                    <span class="status-badge status-{{estado}}">{{estado}}</span>
                </td>
                <td class="center">
                    <div class="action-buttons">
                        <a href="/admin/books/edit/{{_id}}" class="btn-edit">Editar</a>
                        <form action="/admin/books/delete/{{_id}}" method="POST" class="delete-form" onsubmit="return confirm('¬øEliminar este libro?');">
                            <button type="submit" class="btn-delete">Eliminar</button>
                        </form>
                    </div>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>

    {{#if pagination}}
    <div class="limit-selector-container">
        <label for="limit-selector-admin">Libros por p√°gina:</label>
        <select id="limit-selector-admin" class="limit-selector" onchange="changeLimitAdmin(this.value)">
            <option value="10" {{#if (eq limit "10")}}selected{{/if}}>10</option>
            <option value="20" {{#if (eq limit "20")}}selected{{/if}}>20</option>
            <option value="30" {{#if (eq limit "30")}}selected{{/if}}>30</option>
            <option value="40" {{#if (eq limit "40")}}selected{{/if}}>40</option>
        </select>
    </div>
    
    <div class="pagination">
        {{#if pagination.hasPrevPage}}
        <a href="/admin/dashboard?page=1{{#if search}}&search={{search}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}&limit={{limit}}" class="pagination-btn">‚èÆ Inicio</a>
        <a href="/admin/dashboard?page={{pagination.prevPage}}{{#if search}}&search={{search}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}&limit={{limit}}" class="pagination-btn">‚Üê Anterior</a>
        {{else}}
        <span class="pagination-btn disabled">‚èÆ Inicio</span>
        <span class="pagination-btn disabled">‚Üê Anterior</span>
        {{/if}}
        
        <span class="current-page">P√°gina {{pagination.page}} de {{pagination.totalPages}}</span>
        
        {{#if pagination.hasNextPage}}
        <a href="/admin/dashboard?page={{pagination.nextPage}}{{#if search}}&search={{search}}{{/if}}{{#if sort}}&sort={{sort}}{{/if}}&limit={{limit}}" class="pagination-btn">Siguiente ‚Üí</a>
        {{else}}
        <span class="pagination-btn disabled">Siguiente ‚Üí</span>
        {{/if}}
    </div>
    {{/if}}

    {{else}}
    <p class="no-books">No hay libros registrados</p>
    {{/if}}
</div>

<script>
    function changeSortAdmin(newSort) {
        const params = new URLSearchParams(window.location.search);
        const search = params.get('search') || '';
        const limit = params.get('limit') || '10';
        
        const urlParams = new URLSearchParams();
        if (search) urlParams.set('search', search);
        if (limit) urlParams.set('limit', limit);
        if (newSort) urlParams.set('sort', newSort);
        urlParams.set('page', '1');
        
        window.location.href = '/admin/dashboard?' + urlParams.toString();
    }
    
    function changeLimitAdmin(newLimit) {
        const params = new URLSearchParams(window.location.search);
        const search = params.get('search') || '';
        const sort = params.get('sort') || '';
        
        const urlParams = new URLSearchParams();
        if (search) urlParams.set('search', search);
        if (sort) urlParams.set('sort', sort);
        urlParams.set('limit', newLimit);
        urlParams.set('page', '1');
        
        window.location.href = '/admin/dashboard?' + urlParams.toString();
    }
</script>
